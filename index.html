<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Controle de Multas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Reset e estilos gerais */
/* Reset e estilos gerais */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0055a4 0%, #003366 100%);
    min-height: 100vh;
    padding: 20px;
    color: #003366;
}
.container {
    max-width: 1300px;
    margin: 0 auto;
    background: #f0f0f0;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    overflow: hidden;
}
.header {
    background: #003366;
    color: white;
    padding: 30px;
    text-align: center;
}
.header h1 { font-size: 2em; margin-bottom: 10px; }
.content { padding: 30px; }
.auth-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    border: 1px solid #0055a4;
}
.auth-section h2 { color: #003366; margin-bottom: 20px; }
.form-group { margin-bottom: 15px; position: relative; }
.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #003366;
    font-weight: 600;
}
.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #c0c0c0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
}
.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #0073e6;
    box-shadow: 0 0 5px #0073e6;
}
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    margin-right: 10px;
    margin-bottom: 10px;
    color: white;
    user-select: none;
}
.btn-primary {
    background: #003366;
}
.btn-primary:hover {
    background: #0055a4;
    box-shadow: 0 5px 15px rgba(0, 115, 230, 0.5);
    transform: translateY(-2px);
}
.btn-success {
    background: #0073e6;
}
.btn-success:hover {
    background: #0055a4;
    transform: translateY(-2px);
}
.btn-info {
    background: #0055a4;
}
.btn-info:hover {
    background: #003366;
    transform: translateY(-2px);
}
.btn-warning {
    background: #cc9900;
    color: #003366;
}
.btn-warning:hover {
    background: #b38600;
    transform: translateY(-2px);
}
.btn-danger {
    background: #cc0000;
}
.btn-danger:hover {
    background: #990000;
}
.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}
.status-message {
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    font-weight: 600;
}
.status-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.status-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
.multas-section {
    margin-top: 30px;
}
.multas-section h2 {
    color: #003366;
    margin-bottom: 20px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 13px;
    background: white;
    border: 1px solid #c0c0c0;
}
table th {
    background: #003366;
    color: white;
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid #0055a4;
}
table td {
    padding: 12px;
    border-bottom: 1px solid #c0c0c0;
    color: #003366;
}
table tr:hover {
    background: #e6f0ff;
}
.hidden {
    display: none !important;
}
.actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
    align-items: flex-end;
}
.user-info {
    background: #cce0ff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #003366;
    font-weight: 600;
}
.user-info strong {
    color: #003366;
}
#pagination {
    margin-top: 15px;
    text-align: center;
}
        #registerModal input, #registerModal select {
    background-color: white !important;
    color: #003366 !important;
}
#pagination button {
    margin: 0 3px;
    background: #0055a4;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 12px;
    cursor: pointer;
    transition: background-color 0.3s;
}
#pagination button:hover {
    background: #003366;
}
#pagination button.btn-primary {
    background: #003366;
    font-weight: 700;
}
.rows-per-page-container {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #003366;
    font-weight: 600;
}
.stats-header {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
    gap: 20px;
    flex-wrap: wrap;
}
.stat-item {
    background: #003366;
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 51, 102, 0.6);
    flex: 1 1 150px;
    text-align: center;
    font-weight: 700;
    user-select: none;
    transition: transform 0.3s;
}
.stat-item:hover {
    transform: scale(1.05);
}
.stat-item h3 {
    font-size: 2.5rem;
    margin-bottom: 5px;
    font-weight: 900;
}
.stat-item p {
    font-size: 1.1rem;
    font-weight: 600;
    opacity: 0.9;
}
        .autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  max-height: 200px;
  overflow-y: auto;
  font-size: 14px;
}
.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #d4d4d4;
}
.autocomplete-items div:hover, .autocomplete-active {
  background-color: #e9e9e9;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}
.modal-content {
    background-color: #003366;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    color: white;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    position: relative;
}
.modal-content input, 
.modal-content select {
    background-color: #ffffff !important;
    color: #003366 !important;
}
        .modal-content .autocomplete-items {
    background-color: #ffffff;
    color: #003366;
    border: 1px solid #d4d4d4;
}

.modal-content .autocomplete-items div {
    border-bottom: 1px solid #d4d4d4;
}

.modal-content .autocomplete-items div:hover {
    background-color: #e9e9e9;
}
.modal-header {
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-header .close {
    cursor: pointer;
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    user-select: none;
}

/* Sele√ß√£o coluna */
.select-col {
    width: 48px;
    text-align: center;
}
.select-col input[type="checkbox"] {
    transform: scale(1.1);
}

/* Layout do bot√£o de gerar relat√≥rio selecionados */
.report-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 12px;
    gap: 10px;
}

/* Estilo para checkbox quando desabilitado */
.select-col input[type="checkbox"]:disabled {
    cursor: not-allowed;
    opacity: 0.6;
    filter: grayscale(20%);
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Sistema de Controle de Multas</h1>
            <p>Gest√£o completa de multas de tr√¢nsito com Supabase</p>
        </div>

        <div class="content">
            <!-- Se√ß√£o de Autentica√ß√£o -->
            <div id="authSection" class="auth-section">
                <h2 id="authTitle">üîê Autentica√ß√£o</h2>

                <div id="loginFields">
                    <div class="form-group">
                        <label for="authEmail">E-mail:</label>
                        <input type="email" id="authEmail" placeholder="seu@email.com" />
                    </div>

                    <div class="form-group">
                        <label for="authPassword">Senha:</label>
                        <input type="password" id="authPassword" placeholder="Sua senha" />
                    </div>
                </div>

                <div id="registerFields" class="hidden">
                    <div class="form-group">
                        <label for="regNome">Nome Completo:</label>
                        <input type="text" id="regNome" placeholder="Nome do Agente" />
                    </div>
                    <div class="form-group">
                        <label for="regRE">RE:</label>
                        <input type="text" id="regRE" placeholder="Ex: 127861-4" />
                    </div>
                    <div class="form-group">
                        <label for="regCargo">Cargo/Posto:</label>
                        <input type="text" id="regCargo" placeholder="Ex: Sd PM" />
                    </div>
                    <div class="form-group">
                        <label for="regNivel">N√≠vel de Acesso:</label>
                        <select id="regNivel">
                            <option value="agente">Agente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>

                <div class="actions-buttons">
                    <button id="btnLogin" class="btn btn-info" onclick="fazerLogin()">üîë Fazer Login</button>
                    <button id="btnRegister" class="btn btn-success hidden" onclick="cadastrarUsuario()">‚ûï Confirmar Cadastro</button>
                    <button id="btnBackToLogin" class="btn btn-danger hidden" onclick="toggleAuthMode(false)">‚¨ÖÔ∏è Voltar</button>
                    <button class="btn btn-primary" onclick="testarConexao()">üîç Testar Conex√£o DB</button>
                </div>

                <div id="authStatus"></div>
            </div>

            <!-- Informa√ß√µes do Usu√°rio Logado (inicialmente escondida) -->
            <div id="userInfo" class="user-info hidden">
                <div>
                    <strong>Usu√°rio:</strong> <span id="userName" style="font-weight: bold; color: #333;"></span>
                    <span id="userBadge" class="badge"></span>
                    <br />
                    <small><strong>E-mail:</strong> <span id="userEmail"></span> | <strong>RE:</strong> <span id="userRE"></span> | <strong>Posto:</strong> <span id="userPosto"></span></small>
                </div>
                <div>
                    <button id="btnCriarUsuario" class="btn btn-primary admin-only hidden" onclick="abrirModalCadastro()">‚ûï Criar Novo Usu√°rio</button>
                    <button class="btn btn-danger" onclick="fazerLogout()">Sair</button>
                </div>
            </div>

            <!-- Se√ß√£o de Multas (inicialmente escondida) -->
            <div id="multasSection" class="multas-section hidden">
                <!-- Cabe√ßalho de Estat√≠sticas -->
                <div class="stats-header">
                    <div class="stat-item">
                        <h3 id="statTotal">0</h3>
                        <p>üìä Total de Multas</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="statSemanal">0</h3>
                        <p>üìÖ Multas desta Semana</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="statMensal">0</h3>
                        <p>üìÜ Multas deste M√™s</p>
                    </div>
                </div>

                <h2>üìã Cadastro de Multas</h2>

                <form id="multaForm">
                    <div class="form-group">
                        <label for="placa">Placa:</label>
                        <input type="text" id="placa" placeholder="AAA1A11 ou AAA1111" maxlength="7" required />
                    </div>

                    <div class="form-group">
                        <label for="numeroAutoInfracao">N√∫mero do Auto de Infra√ß√£o:</label>
                        <input type="text" id="numeroAutoInfracao" placeholder="N√∫mero do Auto de Infra√ß√£o" required />
                    </div>

<div class="form-group">
  <label for="codigoInfracao">C√≥digo da Infra√ß√£o:</label>
  <input type="text" id="codigoInfracao" placeholder="Ex: 50291" autocomplete="off" required />
  <input type="hidden" id="descricaoInfracao" />
  <div id="descricaoVisivel" style="margin-top: 5px; font-style: italic; color: #555; display: none;"></div>
</div>

                    <div class="form-group">
                        <label for="agenteRE">RE do Agente:</label>
                        <input type="text" id="agenteRE" placeholder="148929-1" autocomplete="off" required />
                        <input type="hidden" id="agenteNome" />
                        <input type="hidden" id="agentePosto" />
                    </div>

                    <div class="form-group">
                        <label for="data">Data:</label>
                        <input type="date" id="data" required />
                    </div>

                    <button type="submit" class="btn btn-primary">Adicionar Multa</button>
                </form>

                <div class="rows-per-page-container">
                    <label for="rowsPerPageSelect">Multas por p√°gina:</label>
                    <select id="rowsPerPageSelect" onchange="changeRowsPerPage()">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>

                <table id="multasTable">
                    <thead>
                        <tr>
                            <th class="select-col">Selecionar</th>
                            <th>Placa</th>
                            <th>N√∫mero do Auto de Infra√ß√£o</th>
                            <th>C√≥digo</th>
                            <th>Descri√ß√£o</th>
                            <th>RE Agente</th>
                            <th>Inserido por (RE)</th>
                            <th>Data</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="multasBody">
                        <tr>
                            <td colspan="9" style="text-align: center; color: #999;">Nenhuma multa</td>
                        </tr>
                    </tbody>
                </table>

                <div class="report-actions">
                    <button id="btnGerarSelecionados" class="btn btn-info admin-only hidden" onclick="gerarRelatorioSelecionados()">üìÑ Gerar Relat√≥rio (selecionados)</button>
                </div>

                <div id="pagination"></div>
            </div>
        </div>
    </div>
<!-- Modal de Cadastro de Novo Usu√°rio -->
<div id="registerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Cadastrar Novo Usu√°rio</h2>
            <span class="close" onclick="fecharModalCadastro()">√ó</span>
        </div>
        <div id="modalRegisterFields">
            <div class="form-group">
                <label for="modRegNome">Nome Completo:</label>
                <input type="text" id="modRegNome" placeholder="Nome do Agente" />
            </div>
            <div class="form-group">
                <label for="modRegEmail">E-mail:</label>
                <input type="email" id="modRegEmail" placeholder="agente@email.com" />
            </div>
            <div class="form-group">
                <label for="modRegPassword">Senha:</label>
                <input type="password" id="modRegPassword" placeholder="M√≠nimo 6 caracteres" />
            </div>
            <div class="form-group">
                <label for="modRegRE">RE:</label>
                <input type="text" id="modRegRE" placeholder="Ex: 123456-7" />
            </div>
            <div class="form-group">
                <label for="modRegCargo">Cargo/Posto:</label>
                <input type="text" id="modRegCargo" placeholder="Ex: Cb PM" />
            </div>
            <div class="form-group">
                <label for="modRegNivel">N√≠vel de Acesso:</label>
                <select id="modRegNivel">
                    <option value="agente">Agente</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
        </div>
        <div class="actions-buttons">
            <button class="btn btn-success" onclick="executarCadastroModal()">‚úÖ Confirmar Cadastro</button>
            <button class="btn btn-danger" onclick="fecharModalCadastro()">‚ùå Cancelar</button>
        </div>
        <div id="modalAuthStatus"></div>
    </div>
</div>
    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Multa</h2>
                <span class="close" onclick="fecharModalEdicao()">√ó</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId" />

                <div class="form-group">
                    <label for="editPlaca">Placa:</label>
                    <input type="text" id="editPlaca" maxlength="7" required />
                </div>

                <div class="form-group">
                    <label for="editNumeroAutoInfracao">N√∫mero do Auto de Infra√ß√£o:</label>
                    <input type="text" id="editNumeroAutoInfracao" required />
                </div>

                <div class="form-group">
                    <label for="editCodigoInfracao">C√≥digo da Infra√ß√£o:</label>
                    <input type="text" id="editCodigoInfracao" autocomplete="off" required />
                    <input type="hidden" id="editDescricaoInfracao" />
                </div>

                <div class="form-group">
                    <label for="editAgenteRE">RE do Agente:</label>
                    <input type="text" id="editAgenteRE" autocomplete="off" required />
                    <input type="hidden" id="editAgenteNome" />
                    <input type="hidden" id="editAgentePosto" />
                </div>

                <div class="form-group">
                    <label for="editData">Data:</label>
                    <input type="date" id="editData" required />
                </div>

                <div class="actions-buttons">
                    <button type="submit" class="btn btn-success">üíæ Salvar Altera√ß√µes</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalEdicao()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para filtro de datas do relat√≥rio (mantido caso queira) -->
    <div id="relatorioModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Gerar Relat√≥rio de Multas</h2>
                <span class="close" onclick="fecharModalRelatorio()">√ó</span>
            </div>
            <form id="relatorioForm" onsubmit="event.preventDefault(); gerarRelatorioPDFModal();">
                <div class="form-group">
                    <label for="relDataInicio">Data In√≠cio:</label>
                    <input type="date" id="relDataInicio" required />
                </div>
                <div class="form-group">
                    <label for="relDataFim">Data Fim:</label>
                    <input type="date" id="relDataFim" required />
                </div>
                <div class="actions-buttons" style="justify-content:flex-end">
                    <button type="submit" class="btn btn-primary">Gerar PDF</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalRelatorio()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
// Vari√°veis globais
        const SUPABASE_URL = 'https://xgfzeujvkjrifetokxff.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnZnpldWp2a2pyaWZldG9reGZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTI1MDgsImV4cCI6MjA4Mzk2ODUwOH0.ldLZUkTvPJ6iXaLpkB1ugX2mrcz3PAY0cwCWorhVwHI';

        let supabaseClient;
        let usuarioLogado = null;
        let perfilUsuario = null;
        let multasAtuais = [];
        let currentPage = 1;
        let rowsPerPage = 5;
        let infracoesCTB = [];

        // Fun√ß√£o para carregar infra√ß√µes do arquivo JSON
        async function carregarInfracoes() {
            try {
                const res = await fetch('infracoes.json');
                infracoesCTB = await res.json();
            } catch (e) {
                console.error('Erro ao carregar infra√ß√µes:', e);
            }
        }
// Fun√ß√£o para abrir o modal de cadastro
function abrirModalCadastro() {
    document.getElementById('registerModal').style.display = 'block';
}

// Fun√ß√£o para fechar o modal de cadastro
function fecharModalCadastro() {
    document.getElementById('registerModal').style.display = 'none';
    document.getElementById('modalAuthStatus').textContent = '';
}

// Fun√ß√£o para executar o cadastro via Modal
async function executarCadastroModal() {
    const email = document.getElementById('modRegEmail').value;
    const password = document.getElementById('modRegPassword').value;
    const nome = document.getElementById('modRegNome').value;
    const re = document.getElementById('modRegRE').value;
    const cargo = document.getElementById('modRegCargo').value;
    const nivel = document.getElementById('modRegNivel').value;

    if(!email || !password || !nome || !re) {
        alert("Preencha todos os campos obrigat√≥rios!");
        return;
    }

    try {
        // 1. Criar usu√°rio no Auth do Supabase
        const { data, error } = await supabaseClient.auth.signUp({
            email,
            password,
            options: { data: { nome_completo: nome } }
        });

        if (error) throw error;

        // 2. Criar perfil na tabela 'perfis'
        const { error: profileError } = await supabaseClient.from('perfis').insert([{
            id: data.user.id,
            nome_completo: nome,
            re: re,
            cargo: cargo,
            nivel_acesso: nivel
        }]);

        if (profileError) throw profileError;

        alert('‚úÖ Usu√°rio cadastrado com sucesso!');
        fecharModalCadastro();
    } catch (err) {
        console.error(err);
        document.getElementById('modalAuthStatus').innerHTML = `<div class="status-message status-error">‚ùå ${err.message}</div>`;
    }
}
        // Fun√ß√£o autocomplete para o campo c√≥digo da infra√ß√£o
        function autocompleteCodigoInfracao(input) {
            let currentFocus;

            input.addEventListener('input', function() {
                const val = this.value.toUpperCase();
                closeAllLists();
                if (!val) return false;
                currentFocus = -1;

                const list = document.createElement('div');
                list.setAttribute('id', this.id + '-autocomplete-list');
                list.setAttribute('class', 'autocomplete-items');
                this.parentNode.appendChild(list);

                let count = 0;
                for (const item of infracoesCTB) {
                    if (item.codigo.startsWith(val) || item.descricao.toUpperCase().includes(val)) {
                        const itemDiv = document.createElement('div');
                        itemDiv.innerHTML = `<strong>${item.codigo}</strong> - ${item.descricao}`;
                        itemDiv.addEventListener('click', () => {
                            const combined = `${item.codigo} - ${item.descricao}`;
                            input.value = combined;
                            document.getElementById('descricaoInfracao').value = item.descricao;
                            const descVis = document.getElementById('descricaoVisivel');
                            if (descVis) descVis.textContent = item.descricao;
                            closeAllLists();
                        });
                        list.appendChild(itemDiv);
                        count++;
                        if (count >= 10) break; // limita a 10 sugest√µes
                    }
                }
            });

            input.addEventListener('keydown', function(e) {
                let list = document.getElementById(this.id + '-autocomplete-list');
                if (list) list = list.getElementsByTagName('div');
                if (e.keyCode == 40) { // seta para baixo
                    currentFocus++;
                    addActive(list);
                } else if (e.keyCode == 38) { // seta para cima
                    currentFocus--;
                    addActive(list);
                } else if (e.keyCode == 13) { // enter
                    e.preventDefault();
                    if (currentFocus > -1 && list) list[currentFocus].click();
                }
            });

            function addActive(list) {
                if (!list) return false;
                removeActive(list);
                if (currentFocus >= list.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = list.length - 1;
                list[currentFocus].classList.add('autocomplete-active');
            }
            function removeActive(list) {
                for (const item of list) {
                    item.classList.remove('autocomplete-active');
                }
            }
            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName('autocomplete-items');
                for (const item of items) {
                    if (elmnt != item && elmnt != input) {
                        item.parentNode.removeChild(item);
                    }
                }
            }
            document.addEventListener('click', (e) => closeAllLists(e.target));
        }

        // Inicializa√ß√£o √∫nica ao carregar a p√°gina
        window.addEventListener('load', async function () {
            if (typeof window.supabase === 'undefined') {
                alert('Erro ao carregar Supabase.');
                return;
            }
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            await verificarSessaoInicial();
            configurarEventos();
            await carregarInfracoes();
autocompleteCodigoInfracao(document.getElementById('codigoInfracao'));
    autocompleteCodigoInfracao(document.getElementById('editCodigoInfracao'));

            // Atualiza descri√ß√£o ao digitar c√≥digo exato
            document.getElementById('codigoInfracao').addEventListener('input', function() {
                const raw = this.value.trim();
                if (raw.includes(' - ')) {
                    const parts = raw.split(' - ');
                    const codigo = parts.shift().trim();
                    const descricao = parts.join(' - ').trim();
                    document.getElementById('descricaoInfracao').value = descricao;
                    const descVis = document.getElementById('descricaoVisivel');
                    if (descVis) descVis.textContent = descricao;
                } else {
                    const val = raw.toUpperCase();
                    const found = infracoesCTB.find(i => i.codigo === val);
                    if (found) {
                        this.value = `${found.codigo} - ${found.descricao}`;
                        document.getElementById('descricaoInfracao').value = found.descricao;
                        const descVis = document.getElementById('descricaoVisivel');
                        if (descVis) descVis.textContent = found.descricao;
                    } else {
                        document.getElementById('descricaoInfracao').value = '';
                        const descVis = document.getElementById('descricaoVisivel');
                        if (descVis) descVis.textContent = '';
                    }
                }
            });
        });

        // Fun√ß√µes globais chamadas pelos bot√µes e outras funcionalidades

        async function fazerLogin() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            mostrarStatus('üîÑ Entrando...', 'info');
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) mostrarStatus('‚ùå ' + error.message, 'error');
            else await carregarPerfil(data.user);
        }

        async function testarConexao() {
            try {
                const { data, error } = await supabaseClient.from('perfis').select('id').limit(1);
                if (error) mostrarStatus('‚ùå Erro ao conectar: ' + error.message, 'error');
                else mostrarStatus('‚úÖ Conex√£o OK', 'success');
            } catch (err) {
                mostrarStatus('‚ùå Erro ao testar conex√£o', 'error');
            }
        }

        async function fazerLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        async function verificarSessaoInicial() {
            try {
                const {
                    data: { session },
                } = await supabaseClient.auth.getSession();
                if (session) {
                    await carregarPerfil(session.user);
                }
            } catch (err) {
                console.error('Erro ao verificar sess√£o:', err);
            }
        }

        async function carregarPerfil(user) {
            usuarioLogado = user;
            try {
                const { data, error } = await supabaseClient.from('perfis').select('*').eq('id', user.id).single();

                if (error) throw error;
                perfilUsuario = data;

                document.getElementById('userName').textContent = perfilUsuario.nome_completo || '';
                document.getElementById('userEmail').textContent = usuarioLogado.email || '';
                document.getElementById('userRE').textContent = perfilUsuario.re || '';
                document.getElementById('userPosto').textContent = perfilUsuario.cargo || '';

                mostrarUsuarioLogado(usuarioLogado, perfilUsuario);

                carregarMultas();

                document.getElementById('agenteRE').value = data.re;
                document.getElementById('agenteNome').value = data.nome_completo;
                document.getElementById('agentePosto').value = data.cargo;
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                mostrarStatus('Erro ao carregar dados do perfil.', 'error');
            }
        }

        function mostrarStatus(msg, tipo) {
            const div = document.getElementById('authStatus');
            if (!div) return;
            div.className = `status-message status-${tipo}`;
            div.textContent = msg;
            div.style.display = 'block';
        }

        function mostrarUsuarioLogado(user, perfil) {
            document.getElementById('authSection').classList.add('hidden');

            document.getElementById('userName').textContent = perfil.nome_completo || '';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('userRE').textContent = perfil.re || '';
            document.getElementById('userPosto').textContent = perfil.cargo || '';

            const badge = document.getElementById('userBadge');
            badge.textContent = perfil.nivel_acesso || 'Usu√°rio';
            badge.className = 'badge ' + (perfil.nivel_acesso === 'admin' ? 'badge-admin' : 'badge-agente');

            const isAdmin = perfil.nivel_acesso === 'admin';
            document.querySelectorAll('.admin-only').forEach((el) => el.classList.toggle('hidden', !isAdmin));

            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('multasSection').classList.remove('hidden');

            renderTablePage(currentPage);
        }

        function configurarEventos() {
            const multaForm = document.getElementById('multaForm');
            if (multaForm) {
                multaForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!usuarioLogado) {
                        alert('Voc√™ precisa estar logado para adicionar multas.');
                        return;
                    }

                    const dataInput = document.getElementById('data').value;
                    if (!dataInput) {
                        alert('Selecione uma data v√°lida.');
                        return;
                    }
                    const dataParaSalvar = dataInput + "T12:00:00";

                    const codigoRaw = document.getElementById('codigoInfracao').value.trim();
                    let codigoParaSalvar = codigoRaw;
                    let descricaoParaSalvar = document.getElementById('descricaoInfracao').value || '';

                    if (codigoRaw.includes(' - ')) {
                        const parts = codigoRaw.split(' - ');
                        codigoParaSalvar = parts.shift().trim();
                        if (!descricaoParaSalvar) descricaoParaSalvar = parts.join(' - ').trim();
                    }

                    const novaMulta = {
                        placa: document.getElementById('placa').value.toUpperCase(),
                        numero_auto_infracao: document.getElementById('numeroAutoInfracao').value,
                        codigo_infracao: codigoParaSalvar,
                        descricao_infracao: descricaoParaSalvar,
                        agente_posto: document.getElementById('agentePosto') ? document.getElementById('agentePosto').value : '',
                        agente_re: document.getElementById('agenteRE').value,
                        agente_nome: document.getElementById('agenteNome').value,
                        data: dataParaSalvar,
                        user_id: usuarioLogado.id,
                    };

                    try {
                        const { error } = await supabaseClient.from('multas').insert([novaMulta]);
                        if (error) {
                            alert('Erro: ' + error.message);
                        } else {
                            alert('‚úÖ Multa adicionada!');
                            document.getElementById('multaForm').reset();
                            document.getElementById('data').valueAsDate = new Date();
                            if (perfilUsuario) {
                                document.getElementById('agenteRE').value = perfilUsuario.re;
                                document.getElementById('agenteNome').value = perfilUsuario.nome_completo;
                                document.getElementById('agentePosto').value = perfilUsuario.cargo;
                            }
                            carregarMultas();
                        }
                    } catch (err) {
                        console.error('Erro ao inserir multa:', err);
                        alert('Erro ao inserir multa. Veja o console.');
                    }
                });
            }

            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await salvarEdicao();
                });
            }

            const placa = document.getElementById('placa');
            if (placa) placa.addEventListener('input', (e) => (e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '')));
            const editPlaca = document.getElementById('editPlaca');
            if (editPlaca) editPlaca.addEventListener('input', (e) => (e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '')));

            const dataElem = document.getElementById('data');
            if (dataElem) dataElem.valueAsDate = new Date();

            const rowsSelect = document.getElementById('rowsPerPageSelect');
            if (rowsSelect) rowsSelect.value = rowsPerPage;
        }

        async function carregarMultas() {
            try {
                const { data: todasMultas, error: errorStats } = await supabaseClient
                    .from('multas')
                    .select('data');

                if (!errorStats) {
                    atualizarEstatisticas(todasMultas || []);
                }

                let query = supabaseClient
                    .from('multas')
                    .select(`
                        *,
                        perfis:user_id ( re )
                    `)
                    .order('data', { ascending: false });

                if (perfilUsuario && perfilUsuario.nivel_acesso !== 'admin' && usuarioLogado) {
                    query = query.eq('user_id', usuarioLogado.id);
                }

                const { data: multasTabela, error: errorTabela } = await query;

                if (!errorTabela) {
                    multasAtuais = multasTabela || [];
                    renderTablePage(currentPage);
                } else {
                    console.error('Erro ao carregar multas da tabela:', errorTabela);
                }
            } catch (err) {
                console.error('Erro na consulta de multas:', err);
            }
        }

        function renderTablePage(page) {
            const tbody = document.getElementById('multasBody');
            tbody.innerHTML = '';
            const isAdmin = perfilUsuario && perfilUsuario.nivel_acesso === 'admin';

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageMultas = multasAtuais.slice(start, end);

            if (pageMultas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #999;">Nenhuma multa</td></tr>`;
                return;
            }

            pageMultas.forEach((multa) => {
                const tr = document.createElement('tr');
                const podeEditar = isAdmin || multa.user_id === (usuarioLogado && usuarioLogado.id);
                const reInseriu = multa.perfis ? multa.perfis.re : '-';

                let dataFormatada = '';
                try {
                    if (multa.data) {
                        const dataISO = multa.data.split('T')[0];
                        dataFormatada = dataISO.split('-').reverse().join('/');
                    }
                } catch (err) {
                    dataFormatada = '';
                }

                const checkboxCell = `
                  <td class="select-col">
                    <input
                      type="checkbox"
                      class="select-multa"
                      data-id="${multa.id}"
                      ${isAdmin ? '' : 'disabled title="Apenas administradores podem selecionar"'}
                    />
                  </td>
                `;

                tr.innerHTML = `
                    ${checkboxCell}
                    <td>${multa.placa}</td>
                    <td>${multa.numero_auto_infracao || '-'}</td>
                    <td>${multa.codigo_infracao}</td>
                    <td>${multa.descricao_infracao || '-'}</td>
                    <td>${multa.agente_re || '-'}</td>
                    <td style="font-weight: bold; color: #667eea;">${reInseriu}</td>
                    <td>${dataFormatada}</td>
                    <td>
                        <div class="action-buttons">
                            ${
                                podeEditar
                                    ? `<button class="btn btn-warning btn-sm" onclick='abrirModalEdicao(${JSON.stringify(multa)})'>‚úèÔ∏è</button>`
                                    : ''
                            }
                            ${
                                isAdmin
                                    ? `<button class="btn btn-danger btn-sm" onclick="excluirMulta('${multa.id}')">üóëÔ∏è</button>`
                                    : ''
                            }
                            ${!podeEditar && !isAdmin ? '<span style="color: #999;">-</span>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.admin-only').forEach((el) => el.classList.toggle('hidden', !(perfilUsuario && perfilUsuario.nivel_acesso === 'admin')));

            renderPagination();
        }

        function renderPagination() {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(multasAtuais.length / rowsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'btn btn-sm';
                if (i === currentPage) btn.classList.add('btn-primary');
                btn.addEventListener('click', () => {
                    currentPage = i;
                    renderTablePage(currentPage);
                });
                paginationContainer.appendChild(btn);
            }
        }

        function changeRowsPerPage() {
            const select = document.getElementById('rowsPerPageSelect');
            rowsPerPage = parseInt(select.value);
            currentPage = 1;
            renderTablePage(currentPage);
        }

        function atualizarEstatisticas(multas) {
            const hoje = new Date();
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            inicioSemana.setHours(0, 0, 0, 0);

            const semanal = multas.filter((m) => {
                try {
                    const dataISO = (m.data || '').split('T')[0];
                    if (!dataISO) return false;
                    const parts = dataISO.split('-');
                    const dt = new Date(parts[0], parts[1] - 1, parts[2]);
                    return dt >= inicioSemana;
                } catch {
                    return false;
                }
            }).length;

            const mensal = multas.filter((m) => {
                try {
                    const dataISO = (m.data || '').split('T')[0];
                    if (!dataISO) return false;
                    const parts = dataISO.split('-');
                    const dt = new Date(parts[0], parts[1] - 1, parts[2]);
                    return dt.getMonth() === hoje.getMonth() && dt.getFullYear() === hoje.getFullYear();
                } catch {
                    return false;
                }
            }).length;

            document.getElementById('statTotal').textContent = multas.length;
            document.getElementById('statSemanal').textContent = semanal;
            document.getElementById('statMensal').textContent = mensal;
        }

        function abrirModalEdicao(multa) {
            document.getElementById('editId').value = multa.id;
            document.getElementById('editPlaca').value = multa.placa;
            document.getElementById('editNumeroAutoInfracao').value = multa.numero_auto_infracao || '';
            document.getElementById('editCodigoInfracao').value = multa.descricao_infracao
                ? `${multa.codigo_infracao} - ${multa.descricao_infracao}`
                : (multa.codigo_infracao || '');
            document.getElementById('editDescricaoInfracao').value = multa.descricao_infracao || '';
            document.getElementById('editAgenteRE').value = multa.agente_re || '';
            document.getElementById('editAgenteNome').value = multa.agente_nome || '';
            document.getElementById('editAgentePosto').value = multa.agente_posto || '';

            try {
                document.getElementById('editData').value = multa.data ? multa.data.split('T')[0] : '';
            } catch {
                document.getElementById('editData').value = '';
            }

            document.getElementById('editModal').style.display = 'block';
        }

        function fecharModalEdicao() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        async function salvarEdicao() {
            const id = document.getElementById('editId').value;
            const dataInput = document.getElementById('editData').value;
            if (!dataInput) {
                alert('Selecione uma data v√°lida.');
                return;
            }
            const dataParaSalvar = dataInput + "T12:00:00";

            const codigoRawEdit = document.getElementById('editCodigoInfracao').value.trim();
            let codigoParaSalvarEdit = codigoRawEdit;
            let descricaoParaSalvarEdit = document.getElementById('editDescricaoInfracao').value || '';

            if (codigoRawEdit.includes(' - ')) {
                const parts = codigoRawEdit.split(' - ');
                codigoParaSalvarEdit = parts.shift().trim();
                if (!descricaoParaSalvarEdit) descricaoParaSalvarEdit = parts.join(' - ').trim();
            }

            const multaAtualizada = {
                placa: document.getElementById('editPlaca').value.toUpperCase(),
                numero_auto_infracao: document.getElementById('editNumeroAutoInfracao').value,
                codigo_infracao: codigoParaSalvarEdit,
                descricao_infracao: descricaoParaSalvarEdit,
                agente_posto: document.getElementById('editAgentePosto') ? document.getElementById('editAgentePosto').value : '',
                agente_re: document.getElementById('editAgenteRE').value,
                agente_nome: document.getElementById('editAgenteNome').value,
                data: dataParaSalvar,
            };

            try {
                const { error } = await supabaseClient.from('multas').update(multaAtualizada).eq('id', id);

                if (error) {
                    alert('‚ùå Erro ao atualizar: ' + error.message);
                } else {
                    alert('‚úÖ Multa atualizada com sucesso!');
                    fecharModalEdicao();
                    carregarMultas();
                }
            } catch (err) {
                console.error('Erro ao atualizar multa:', err);
                alert('Erro ao atualizar multa. Veja o console.');
            }
        }

        async function excluirMulta(id) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir esta multa?')) return;
            try {
                const { error } = await supabaseClient.from('multas').delete().eq('id', id);
                if (error) alert('‚ùå Erro ao excluir: ' + error.message);
                else {
                    alert('‚úÖ Multa exclu√≠da!');
                    carregarMultas();
                }
            } catch (err) {
                console.error('Erro ao excluir:', err);
                alert('Erro ao excluir. Veja o console.');
            }
        }

        async function fazerLogin() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            mostrarStatus('üîÑ Entrando...', 'info');
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) mostrarStatus('‚ùå ' + error.message, 'error');
            else await carregarPerfil(data.user);
        }

        async function fazerLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        function mostrarUsuarioLogado(user, perfil) {
            // Esconde a se√ß√£o de autentica√ß√£o
            document.getElementById('authSection').classList.add('hidden');

            // Preenche campos (j√° feitos em carregarPerfil, mas repetimos para garantir)
            document.getElementById('userName').textContent = perfil.nome_completo || '';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('userRE').textContent = perfil.re || '';
            document.getElementById('userPosto').textContent = perfil.cargo || '';

            // Atualiza badge e controles de admin
            const badge = document.getElementById('userBadge');
badge.textContent = perfil.nivel_acesso || 'Usu√°rio';
badge.className = 'badge ' + (perfil.nivel_acesso === 'admin' ? 'badge-admin' : 'badge-agente');

            const isAdmin = perfil.nivel_acesso === 'admin';
            document.querySelectorAll('.admin-only').forEach((el) => el.classList.toggle('hidden', !isAdmin));

            // Mostrar a barra de usu√°rio e a se√ß√£o de multas (somente agora)
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('multasSection').classList.remove('hidden');

            // Re-renderiza a tabela para garantir checkboxes corretos
            renderTablePage(currentPage);
        }

        async function carregarMultas() {
            try {
                // 1. BUSCA GLOBAL (Para as Estat√≠sticas)
                const { data: todasMultas, error: errorStats } = await supabaseClient
                    .from('multas')
                    .select('data'); // Pegamos apenas a data para performance

                if (!errorStats) {
                    atualizarEstatisticas(todasMultas || []);
                }

                // 2. BUSCA FILTRADA (Para a Tabela)
                let query = supabaseClient
                    .from('multas')
                    .select(`
                        *,
                        perfis:user_id ( re )
                    `)
                    .order('data', { ascending: false });

                // Se n√£o for admin, filtra a tabela para mostrar apenas as dele
                if (perfilUsuario && perfilUsuario.nivel_acesso !== 'admin' && usuarioLogado) {
                    query = query.eq('user_id', usuarioLogado.id);
                }

                const { data: multasTabela, error: errorTabela } = await query;
                
                if (!errorTabela) {
                    multasAtuais = multasTabela || [];
                    renderTablePage(currentPage);
                } else {
                    console.error('Erro ao carregar multas da tabela:', errorTabela);
                }

            } catch (err) {
                console.error('Erro na consulta de multas:', err);
            }
        }

        function renderTablePage(page) {
            const tbody = document.getElementById('multasBody');
            tbody.innerHTML = '';
            const isAdmin = perfilUsuario && perfilUsuario.nivel_acesso === 'admin';

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageMultas = multasAtuais.slice(start, end);

            if (pageMultas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #999;">Nenhuma multa</td></tr>`;
                return;
            }

            pageMultas.forEach((multa) => {
                const tr = document.createElement('tr');
                const podeEditar = isAdmin || multa.user_id === (usuarioLogado && usuarioLogado.id);
                const reInseriu = multa.perfis ? multa.perfis.re : '-';

                let dataFormatada = '';
                try {
                    if (multa.data) {
                        const dataISO = multa.data.split('T')[0];
                        dataFormatada = dataISO.split('-').reverse().join('/');
                    }
                } catch (err) {
                    dataFormatada = '';
                }

                const checkboxCell = `
                  <td class="select-col">
                    <input
                      type="checkbox"
                      class="select-multa"
                      data-id="${multa.id}"
                      ${isAdmin ? '' : 'disabled title="Apenas administradores podem selecionar"'}
                    />
                  </td>
                `;

                tr.innerHTML = `
                    ${checkboxCell}
                    <td>${multa.placa}</td>
                    <td>${multa.numero_auto_infracao || '-'}</td>
                    <td>${multa.codigo_infracao}</td>
                    <td>${multa.descricao_infracao || '-'}</td>
                    <td>${multa.agente_re || '-'}</td>
                    <td style="font-weight: bold; color: #667eea;">${reInseriu}</td>
                    <td>${dataFormatada}</td>
                    <td>
                        <div class="action-buttons">
                            ${
                                podeEditar
                                    ? `<button class="btn btn-warning btn-sm" onclick='abrirModalEdicao(${JSON.stringify(multa)})'>‚úèÔ∏è</button>`
                                    : ''
                            }
                            ${
                                isAdmin
                                    ? `<button class="btn btn-danger btn-sm" onclick="excluirMulta('${multa.id}')">üóëÔ∏è</button>`
                                    : ''
                            }
                            ${!podeEditar && !isAdmin ? '<span style="color: #999;">-</span>' : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.admin-only').forEach((el) => el.classList.toggle('hidden', !(perfilUsuario && perfilUsuario.nivel_acesso === 'admin')));

            renderPagination();
        }

        function renderPagination() {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(multasAtuais.length / rowsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'btn btn-sm';
                if (i === currentPage) btn.classList.add('btn-primary');
                btn.addEventListener('click', () => {
                    currentPage = i;
                    renderTablePage(currentPage);
                });
                paginationContainer.appendChild(btn);
            }
        }

        function changeRowsPerPage() {
            const select = document.getElementById('rowsPerPageSelect');
            rowsPerPage = parseInt(select.value);
            currentPage = 1;
            renderTablePage(currentPage);
        }

        function atualizarEstatisticas(multas) {
            const hoje = new Date();
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            inicioSemana.setHours(0, 0, 0, 0);

            const semanal = multas.filter((m) => {
                try {
                    const dataISO = (m.data || '').split('T')[0];
                    if (!dataISO) return false;
                    const parts = dataISO.split('-');
                    const dt = new Date(parts[0], parts[1] - 1, parts[2]);
                    return dt >= inicioSemana;
                } catch {
                    return false;
                }
            }).length;

            const mensal = multas.filter((m) => {
                try {
                    const dataISO = (m.data || '').split('T')[0];
                    if (!dataISO) return false;
                    const parts = dataISO.split('-');
                    const dt = new Date(parts[0], parts[1] - 1, parts[2]);
                    return dt.getMonth() === hoje.getMonth() && dt.getFullYear() === hoje.getFullYear();
                } catch {
                    return false;
                }
            }).length;

            document.getElementById('statTotal').textContent = multas.length;
            document.getElementById('statSemanal').textContent = semanal;
            document.getElementById('statMensal').textContent = mensal;
        }

        function abrirModalEdicao(multa) {
            document.getElementById('editId').value = multa.id;
            document.getElementById('editPlaca').value = multa.placa;
            document.getElementById('editNumeroAutoInfracao').value = multa.numero_auto_infracao || '';
            document.getElementById('editCodigoInfracao').value = multa.descricao_infracao
  ? `${multa.codigo_infracao} - ${multa.descricao_infracao}`
  : (multa.codigo_infracao || '');
document.getElementById('editDescricaoInfracao').value = multa.descricao_infracao || '';
            document.getElementById('editAgenteRE').value = multa.agente_re || '';
            document.getElementById('editAgenteNome').value = multa.agente_nome || '';
            document.getElementById('editAgentePosto').value = multa.agente_posto || '';

            try {
                document.getElementById('editData').value = multa.data ? multa.data.split('T')[0] : '';
            } catch {
                document.getElementById('editData').value = '';
            }

            document.getElementById('editModal').style.display = 'block';
        }

        function fecharModalEdicao() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        async function salvarEdicao() {
            const id = document.getElementById('editId').value;
            const dataInput = document.getElementById('editData').value; // "YYYY-MM-DD"
            if (!dataInput) {
                alert('Selecione uma data v√°lida.');
                return;
            }
            const dataParaSalvar = dataInput + "T12:00:00";

const codigoRawEdit = document.getElementById('editCodigoInfracao').value.trim();
let codigoParaSalvarEdit = codigoRawEdit;
let descricaoParaSalvarEdit = document.getElementById('editDescricaoInfracao').value || '';

if (codigoRawEdit.includes(' - ')) {
  const parts = codigoRawEdit.split(' - ');
  codigoParaSalvarEdit = parts.shift().trim();
  if (!descricaoParaSalvarEdit) descricaoParaSalvarEdit = parts.join(' - ').trim();
}

const multaAtualizada = {
  placa: document.getElementById('editPlaca').value.toUpperCase(),
  numero_auto_infracao: document.getElementById('editNumeroAutoInfracao').value,
  codigo_infracao: codigoParaSalvarEdit,
  descricao_infracao: descricaoParaSalvarEdit,
  agente_posto: document.getElementById('editAgentePosto') ? document.getElementById('editAgentePosto').value : '',
  agente_re: document.getElementById('editAgenteRE').value,
  agente_nome: document.getElementById('editAgenteNome').value,
  data: dataParaSalvar,
};

            try {
                const { error } = await supabaseClient.from('multas').update(multaAtualizada).eq('id', id);

                if (error) {
                    alert('‚ùå Erro ao atualizar: ' + error.message);
                } else {
                    alert('‚úÖ Multa atualizada com sucesso!');
                    fecharModalEdicao();
                    carregarMultas();
                }
            } catch (err) {
                console.error('Erro ao atualizar multa:', err);
                alert('Erro ao atualizar multa. Veja o console.');
            }
        }

        async function excluirMulta(id) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir esta multa?')) return;
            try {
                const { error } = await supabaseClient.from('multas').delete().eq('id', id);
                if (error) alert('‚ùå Erro ao excluir: ' + error.message);
                else {
                    alert('‚úÖ Multa exclu√≠da!');
                    carregarMultas();
                }
            } catch (err) {
                console.error('Erro ao excluir:', err);
                alert('Erro ao excluir. Veja o console.');
            }
        }

        function mostrarStatus(msg, tipo) {
            const div = document.getElementById('authStatus');
            if (!div) return;
            div.className = `status-message status-${tipo}`;
            div.textContent = msg;
            div.style.display = 'block';
        }

        async function testarConexao() {
            try {
                const { data, error } = await supabaseClient.from('perfis').select('id').limit(1);
                if (error) mostrarStatus('‚ùå Erro ao conectar: ' + error.message, 'error');
                else mostrarStatus('‚úÖ Conex√£o OK', 'success');
            } catch (err) {
                mostrarStatus('‚ùå Erro ao testar conex√£o', 'error');
            }
        }

        // Gera relat√≥rio apenas com multas selecionadas (apenas admin v√™ o bot√£o e checkboxes)
        // Helper: carrega uma imagem remota e retorna dataURL (base64)
        async function loadImageAsDataURL(url) {
            const res = await fetch(url, { mode: 'cors' });
            if (!res.ok) throw new Error('N√£o foi poss√≠vel carregar a imagem do logo.');
            const blob = await res.blob();
            return await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject('Erro ao converter imagem em dataURL');
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

async function gerarRelatorioSelecionados() {
  // checagem de permiss√£o
  if (!perfilUsuario || perfilUsuario.nivel_acesso !== 'admin') {
    alert('Apenas administradores podem gerar este relat√≥rio.');
    return;
  }

  const checkboxes = Array.from(document.querySelectorAll('.select-multa:checked'));
  if (checkboxes.length === 0) {
    alert('Selecione pelo menos uma multa para gerar o relat√≥rio.');
    return;
  }
  const idsSelecionados = checkboxes.map((cb) => cb.getAttribute('data-id'));
  const multasSelecionadas = multasAtuais.filter((m) => idsSelecionados.includes(String(m.id)));

  const oficioNum = prompt('Informe o n√∫mero do OF√çCIO (apenas o n√∫mero):', '');
  if (oficioNum === null) return;

  // helper para carregar imagem via URL (retorna HTMLImageElement)
  function loadImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => resolve(img);
      img.onerror = (e) => reject(e);
      img.src = url;
    });
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // margens e dimens√µes
    const marginX = 50;
    const marginTop = 40;
    const marginBottom = 40;

    // Bloco esquerdo (logo + contato)
    const bloco1Width = 120;
    const bloco1X = marginX;
    const logoHeight = 80;
    const logoY = marginTop;

    // Bloco direito (onde normalmente fica o texto do of√≠cio e a tabela)
    const gapBetweenBlocks = 20;
    const bloco2X = bloco1X + bloco1Width + gapBetweenBlocks;
    const bloco2Width = pageWidth - marginX * 2 - bloco1Width - gapBetweenBlocks;

    // desenhar imagem (logo)
    const logoUrl = 'https://cdn.abacus.ai/images/b4cc4328-e138-4e89-a5e0-af97e97cf064.png';
    try {
      const img = await loadImage(logoUrl);
      const logoWidth = bloco1Width;
      const ratio = Math.min(logoWidth / img.width, logoHeight / img.height);
      const drawW = img.width * ratio;
      const drawH = img.height * ratio;
      const drawX = bloco1X + (bloco1Width - drawW) / 2;
      const drawY = logoY + (logoHeight - drawH) / 2;
      doc.addImage(img, 'PNG', drawX, drawY, drawW, drawH);
    } catch (err) {
      console.warn('N√£o foi poss√≠vel carregar o logotipo:', err);
    }

    // contato (centralizado dentro do bloco esquerdo)
    const contatoYStart = logoY + logoHeight + 10;
    doc.setFont('Times', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(0, 0, 0);

    const contatoLinhas = [
      '24bpmi1cia@policiamilitar.sp.gov.br',
      'Av. Sen. Marcos Freire, n¬∫ 169,',
      'Jd. Aeroporto, SJBVista/SP.',
      'Fone-(19) 3623-3623'
    ];
    contatoLinhas.forEach((linha, i) => {
      const yLinha = contatoYStart + i * 14;
      const textWidth = doc.getTextWidth(linha);
      const x = bloco1X + (bloco1Width / 2) - (textWidth / 2);
      doc.text(linha, x, yLinha);
    });

    // --- Cabe√ßalho e informa√ß√µes iniciais no bloco direito ---
    let y = marginTop;
    doc.setFont('Times', 'bold');
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);

    doc.text('SECRETARIA DA SEGURAN√áA P√öBLICA', bloco2X, y);
    y += 18;
    doc.text('POL√çCIA MILITAR DO ESTADO DE S√ÉO PAULO', bloco2X, y);
    y += 22;

    doc.setFont('Times', 'normal');
    doc.setFontSize(11);

    const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
    const hoje = new Date();
    const dataFormatada = `${hoje.getDate()} de ${meses[hoje.getMonth()]} de ${hoje.getFullYear()}.`;
    doc.text(`S√£o Jo√£o da Boa Vista, ${dataFormatada}`, bloco2X, y);
    y += 18;

    doc.text(`OFICIO N¬∫ 24BPMI-${oficioNum}/100/26`, bloco2X, y);
    y += 18;
    doc.text('Do Comandante da 1¬™ Cia PM', bloco2X, y);
    y += 18;
    doc.text('A Ilma. Sra. Andr√©a Parolin Pavani Perinoti.', bloco2X, y);
    y += 18;

    const destinatario = 'DD Diretora do Departamento de Seguran√ßa e Tr√¢nsito de S√£o Jo√£o Boa Vista/SP.';
    const destinatarioSplit = doc.splitTextToSize(destinatario, bloco2Width);
    doc.text(destinatarioSplit, bloco2X, y);
    y += destinatarioSplit.length * 14;

    doc.setFont('Times', 'normal');
    doc.setFontSize(11);
    doc.text('Assunto: Autos de Infra√ß√£o Municipais.', bloco2X, y);
    y += 18;

    // --- Anexo: colocado IMEDIATAMENTE abaixo do Assunto, alinhado ao bloco direito (como voc√™ pediu)
    const infoAnexo = `Anexo: ${multasSelecionadas.length} autos de infra√ß√£o.`;
    doc.text(infoAnexo, bloco2X, y);
    y += 40;

    // --- Texto formal: ocupa agora a largura TOTAL da p√°gina (entre marginX e pageWidth - marginX)
    const textoFormal = 'Encaminho a Vossa Senhoria, para conhecimento e provid√™ncias cab√≠veis, as multas constantes em anexo.';
    doc.setFontSize(11);
    const textoSplitFull = doc.splitTextToSize(textoFormal, pageWidth - marginX * 2);

    // Garantir que o par√°grafo n√£o comece sobrepondo o bloco do logo/contato
    const bottomLogoArea = contatoYStart + contatoLinhas.length * 14;
    // Se y (onde est√° ap√≥s Anexo) estiver acima do bottomLogoArea, ajustamos para abaixo do mesmo
    if (y < bottomLogoArea + 6) {
      y = bottomLogoArea + 6;
    }

    // Verifica se o par√°grafo cabe na p√°gina, se n√£o, adiciona p√°gina
    const fontSize = doc.getFontSize(); // em pt
    const lineHeightFactor = 1.15;
    const alturaTexto = textoSplitFull.length * fontSize * lineHeightFactor;
    if (y + alturaTexto > pageHeight - marginBottom) {
      doc.addPage();
      y = marginTop;
    }

    // Escreve o par√°grafo ocupando a largura total entre as margens
    doc.text(textoSplitFull, marginX, y);
    y += alturaTexto + 12; // espa√ßo extra antes da tabela

    // --- Agora desenha a tabela; ela ficar√° com largura TOTAL entre as margens (lado a lado do logo)
    const tabelaDados = multasSelecionadas.map(multa => {
      const dataISO = multa.data ? (typeof multa.data === 'string' ? multa.data.split('T')[0] : multa.data) : '';
      const dataFormatada = (dataISO && typeof dataISO === 'string' && dataISO.includes('-')) ? dataISO.split('-').reverse().join('/') : dataISO || '';
      return [
        multa.placa || '-',
        multa.numero_auto_infracao || '-',
        multa.codigo_infracao || '-',
        multa.descricao_infracao || '-',
        multa.agente_re || '-',
        dataFormatada || '-'
      ];
    });

    // Se a tabela iniciar muito em cima da margem inferior atual, cria nova p√°gina
    if (y + 30 > pageHeight - marginBottom) {
      doc.addPage();
      y = marginTop;
    }

    doc.autoTable({
      startY: y,
      margin: { left: marginX, right: marginX },           // usa margens da p√°gina inteira
      tableWidth: pageWidth - marginX * 2,                 // largura total entre margens
      head: [['Placa', 'Auto Infra√ß√£o', 'C√≥digo', 'Descri√ß√£o', 'RE Agente', 'Data']],
      body: tabelaDados,
      styles: { fontSize: 9 },
      headStyles: { fillColor: [102, 126, 234], textColor: 255 },
      didDrawPage: function (data) {
        // opcional: n√∫mero de p√°gina no rodap√©
        const pageNumber = doc.internal.getNumberOfPages();
        doc.setFontSize(9);
        doc.text(`P√°gina ${pageNumber}`, pageWidth - marginX, pageHeight - 20, { align: 'right' });
      }
    });

    // assinatura (abaixo da tabela)
    const assinaturaNome = 'DANIEL FERREIRA LOPES';
    const assinaturaCargo = 'Cap PM Comandante';
    const assinaturaOffsetY = 82;

    const tabelaFinalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : (y + 100);
    let sigY = tabelaFinalY + assinaturaOffsetY;

    const requiredSpaceForSignature = 60;
    if (sigY + requiredSpaceForSignature > pageHeight - marginBottom) {
      doc.addPage();
      sigY = marginTop + 60;
    }

    doc.setFont('Times', 'normal');
    doc.setFontSize(11);
    const sigX_Right = pageWidth - marginX;
    doc.text(assinaturaNome, sigX_Right, sigY, { align: 'right' });

    doc.setFontSize(10);
    doc.text(assinaturaCargo, sigX_Right, sigY + 16, { align: 'right' });

    // rodap√© com linha e frase
    const rodapeLineY = pageHeight - 60;
    const linhaX1 = marginX;
    const linhaX2 = pageWidth - marginX;

    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(linhaX1, rodapeLineY, linhaX2, rodapeLineY);

    const fraseRodape = '‚ÄúN√≥s, Policiais Militares, sob a prote√ß√£o de Deus, estamos compromissados com a defesa da Vida, da Integridade F√≠sica e da Dignidade da Pessoa Humana‚Äù';
    doc.setFont('Times', 'italic');
    doc.setFontSize(7);
    doc.text(fraseRodape, pageWidth / 2, rodapeLineY + 14, { align: 'center' });

    // salva o arquivo
    const ts = new Date().toISOString().replace(/[:.]/g, '-');
    doc.save(`relatorio_multas_oficio_${oficioNum || 'sem-num'}_${ts}.pdf`);
  } catch (err) {
    console.error('Erro ao gerar PDF:', err);
    alert('Erro ao gerar o relat√≥rio. Veja o console para detalhes.');
  }
}

        // Mantive a fun√ß√£o de gerar relat√≥rio por per√≠odo (modal) caso queira reutilizar
        function abrirModalRelatorio() {
            document.getElementById('relatorioModal').style.display = 'block';
            document.getElementById('relatorioModal').classList.remove('hidden');
            const hoje = new Date();
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            document.getElementById('relDataInicio').valueAsDate = primeiroDiaMes;
            document.getElementById('relDataFim').valueAsDate = hoje;
        }

        function fecharModalRelatorio() {
            document.getElementById('relatorioModal').style.display = 'none';
            document.getElementById('relatorioModal').classList.add('hidden');
            document.getElementById('relatorioForm').reset();
        }

        async function gerarRelatorioPDFModal() {
            // Fun√ß√£o mantida (gera baseado em per√≠odo). N√£o altera seu pedido principal.
            const dataInicio = document.getElementById('relDataInicio').value;
            const dataFim = document.getElementById('relDataFim').value;

            if (!dataInicio || !dataFim) {
                alert('Por favor, selecione as duas datas.');
                return;
            }

            if (dataFim < dataInicio) {
                alert('A data final deve ser maior ou igual √† data inicial.');
                return;
            }

            fecharModalRelatorio();

            const dataInicioISO = dataInicio + "T00:00:00";
            const dataFimISO = dataFim + "T23:59:59";

            try {
                const { data: multasFiltradas, error } = await supabaseClient
                    .from('multas')
                    .select('*')
                    .gte('data', dataInicioISO)
                    .lte('data', dataFimISO)
                    .order('data', { ascending: true });

                if (error) {
                    alert('Erro ao buscar multas: ' + error.message);
                    return;
                }

                if (!multasFiltradas || multasFiltradas.length === 0) {
                    alert('Nenhuma multa encontrada no per√≠odo selecionado.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.text('Relat√≥rio de Multas', 14, 22);

                const nomeUsuario = perfilUsuario ? perfilUsuario.nome_completo : 'Usu√°rio desconhecido';
                doc.setFontSize(12);
                doc.text(`Gerado por: ${nomeUsuario}`, 14, 30);

                const tabelaDados = multasFiltradas.map(multa => [
                    multa.placa,
                    multa.numero_auto_infracao || '-',
                    multa.codigo_infracao,
                    multa.descricao_infracao || '-',
                    multa.agente_re || '-',
                    formatarData(multa.data ? multa.data.split('T')[0] : ''),
                ]);

                doc.autoTable({
                    startY: 40,
                    head: [['Placa', 'Auto Infra√ß√£o', 'C√≥digo', 'Descri√ß√£o', 'RE Agente', 'Data']],
                    body: tabelaDados,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [102, 126, 234] },
                    margin: { left: 14, right: 14 },
                });

                const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 40;
                doc.setFontSize(12);
                doc.text(`Quantidade total de multas: ${multasFiltradas.length}`, 14, finalY + 10);

                const ts = new Date().toISOString().replace(/[:.]/g, '-');
                doc.save(`relatorio_multas_periodo_${ts}.pdf`);
            } catch (err) {
                alert('Erro ao gerar relat√≥rio. Veja o console.');
                console.error(err);
            }
        }

        function formatarData(dataISO) {
            if (!dataISO) return '';
            const partes = dataISO.split('-');
            if (partes.length < 3) return dataISO;
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        // Fecha modais ao clicar fora
window.onclick = function (event) {
            const modalRel = document.getElementById('relatorioModal');
            if (event.target == modalRel) {
                fecharModalRelatorio();
            }
            const modalEdit = document.getElementById('editModal');
            if (event.target == modalEdit) {
                fecharModalEdicao();
            }
        };
    </script>
</body>
</html>
